<!DOCTYPE html>
<html lang="de" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Offene Geisternetze</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" defer></script>
</head>
<body class="bg-light">
<div th:replace="~{fragments/navbar :: navbar}"></div>

<div class="container py-5">
    <div th:replace="~{fragments/ghostnet-nav :: ghostnetNav('/ghostnets/unassigned')}"></div>

    <h2 class="mb-4">Noch zu bergende Geisternetze</h2>

    <div th:if="${nets.isEmpty()}" class="alert alert-info">
        Aktuell gibt es keine unzugewiesenen Geisternetze.
    </div>

    <!-- Erfolgs-/Fehlermeldungen -->
    <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>
    <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>

    <div class="row g-3 mb-3">
        <div class="col-12 col-md-6" th:each="net : ${nets}">
            <div class="card h-100 shadow-sm">
                <div class="card-body">
                    <div class="row">
                        <!-- Linker Bereich: Koordinaten, Größe, Gemeldet von -->
                        <div class="col-12 col-sm-8">
                            <small class="text-muted">Koordinaten</small>
                            <a class="link-underline link-underline-opacity-0"
                               th:href="'https://www.google.com/maps?q=' + ${net.latitude} + ',' + ${net.longitude}"
                               target="_blank">
                                <h5 class="mb-1" th:text="${net.latitude + '  ' + net.longitude}"></h5>
                            </a>
                            <p class="mb-1">Geschätzte Größe: <span th:text="${net.estimatedSize}">n/a</span></p>
                            <p class="mb-0 text-muted" th:if="${net.reportedBy != null}">
                                Gemeldet von: <span th:text="${net.reportedBy.firstname + ' ' + net.reportedBy.lastname}"></span>
                                (<span th:text="${net.reportedBy.phonenumber}"></span>)
                            </p>
                            <p class="mb-0 text-muted" th:if="${net.reportedBy == null}">Gemeldet von: Anonym</p>
                        </div>

                        <!-- Rechter Bereich (Buttons) -->
                        <div class="col-12 col-sm-4 d-flex flex-column align-items-sm-end mt-3 mt-sm-0" th:if="${session.user != null}">
                            <!-- Netz bergen Button -->
                            <button type="button"
                                    class="btn btn-primary btn-sm mb-2"
                                    data-bs-toggle="modal"
                                    th:attr="data-bs-target='#confirmModalAssign__' + ${net.id}">
                                Netz bergen
                            </button>

                            <!-- Netz verschollen melden Button -->
                            <button type="button"
                                    class="btn btn-outline-danger btn-sm"
                                    data-bs-toggle="modal"
                                    th:attr="data-bs-target='#confirmModalLost__' + ${net.id}">
                                Netz verschollen
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Modals -->


            <!-- Netz bergen Modal -->
            <div th:if="${session.user != null}" class="modal fade" th:id="'confirmModalAssign__' + ${net.id}" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Netz bergen bestätigen</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Schließen"></button>
                        </div>
                        <div class="modal-body">
                            <p>
                                Möchtest du die Bergung für das Netz bei
                                <strong th:text="${net.latitude + ' / ' + net.longitude}"></strong>
                                übernehmen?
                            </p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                            <form th:action="@{'/ghostnets/' + ${net.id} + '/assign'}" method="post" class="m-0">
                                <input type="hidden" name="userId" th:value="${session.user.id}">
                                <button type="submit" class="btn btn-primary">Ja, Bergung übernehmen</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Verschollen melden Modal -->
            <div th:if="${session.user != null}" class="modal fade" th:id="'confirmModalLost__' + ${net.id}" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Netz als verschollen melden</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Schließen"></button>
                        </div>
                        <div class="modal-body">
                            <p>
                                Bist du sicher, dass du das Netz bei
                                <strong th:text="${net.latitude + ' / ' + net.longitude}"></strong>
                                als <strong>verschollen</strong> melden möchtest?
                            </p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                            <form th:action="@{'/ghostnets/' + ${net.id} + '/report-lost'}" method="post" class="m-0">
                                <input type="hidden" name="userId" th:value="${session.user.id}">
                                <input type="hidden" name="redirectTo" value="/ghostnets/unassigned">
                                <button type="submit" class="btn btn-danger">Ja, Netz als verschollen melden</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</body>
</html>